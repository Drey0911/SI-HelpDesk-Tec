{% extends "base.html" %}

{% block content %}

<div class="row">
    <div class="col-xl-12">
        
        <section class="box-typical box-typical-dashboard panel panel-default scrollable">
            <header class="box-typical-header panel-heading">
                <h3 class="panel-title">Gestión de Tickets</h3>
            </header>
            <div class="box-typical-body panel-body">
                
                <!-- Botón para crear nuevo ticket (solo USER) -->
                {% if user.role == 'USER' %}
                    <div>
                        <button type="button" 
                                class="btn btn-primary create-ticket-btn" 
                                data-toggle="modal" 
                                data-target="#createTicketModal">
                            <i class="font-icon font-icon-plus"></i> Crear Nuevo Ticket
                        </button>
                    </div>
                {% endif %}
                
                <!-- Tabla de tickets -->
                <div class="table-responsive">
                    <table id="tickets-table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Descripción</th>
                                <th>Estado</th>
                                <th>Prioridad</th>
                                <th>Departamento</th>
                                <th>Fecha Creación</th>
                                <th>Técnico Asignado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in tickets %}
                            <tr>
                                <td>{{ ticket.id }}</td>
                                <td>{{ ticket.titulo }}</td>
                                <td>{{ ticket.descripcion }}</td>
                                <td>
                                    <span class="label 
                                        {% if ticket.estado == 'Abierto' %}label-success
                                        {% elif ticket.estado == 'En Progreso' %}label-warning
                                        {% elif ticket.estado == 'Cerrado' %}label-danger
                                        {% else %}label-default{% endif %}">
                                        {{ ticket.estado }}
                                    </span>
                                </td>
                                <td>{{ ticket.prioridad }}</td>
                                <td>{{ ticket.departamento }}</td>
                                <td>{{ ticket.fecha_creacion }}</td>
                                <td>
                                    {% if ticket.tecnico_nombre %}
                                        {{ ticket.tecnico_nombre }} {{ ticket.tecnico_apellido }}
                                    {% else %}
                                        Sin asignar
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.role == 'ADMIN' %}
                                    <button type="button" class="btn btn-sm btn-info" data-toggle="modal" 
                                            data-target="#editTicketModal" data-ticketid="{{ ticket.id }}"
                                            data-estado="{{ ticket.estado }}" data-prioridad="{{ ticket.prioridad }}"
                                            data-departamento="{{ ticket.departamento }}" 
                                            data-tecnico="{{ ticket.idTecnico }}">
                                        <i class="font-icon font-icon-edit"></i> Editar
                                    </button>
                                    {% elif user.role == 'TEC' %}
                                    <button type="button" class="btn btn-sm btn-info" data-toggle="modal" 
                                            data-target="#editTicketModal" data-ticketid="{{ ticket.id }}"
                                            data-estado="{{ ticket.estado }}">
                                        <i class="font-icon font-icon-edit"></i> Cambiar Estado
                                    </button>
                                    {% elif user.role == 'USER' and ticket.idUsuario == user.id %}
                                    <form action="{{ url_for('delete_ticket', ticket_id=ticket.id) }}" method="POST" 
                                          class="d-inline delete-form">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="font-icon font-icon-trash"></i> Eliminar
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="text-muted">No actions</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Modal para crear ticket -->
<div class="modal fade" id="createTicketModal" tabindex="-1" role="dialog" aria-labelledby="createTicketModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="createTicketModalLabel">Crear Nuevo Ticket</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="{{ url_for('create_ticket') }}" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="titulo">Título</label>
                        <input type="text" class="form-control" id="titulo" name="titulo" required>
                    </div>
                    <div class="form-group">
                        <label for="descripcion">Descripción</label>
                        <textarea class="form-control" id="descripcion" name="descripcion" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="departamento">Departamento</label>
                        <select class="form-control" id="departamento" name="departamento">
                            <option value="Tecnología">Tecnología</option>
                            <option value="Contabilidad">Contabilidad</option>
                            <option value="Gerencia">Gerencia</option>
                            <option value="Recursos Humanos">Recursos Humanos</option>
                            <option value="Ventas">Ventas</option>
                            <option value="Soporte">Soporte</option>
                        </select>
                    </div>
                    {% if user.role == 'USER' %}
                    <div class="form-group">
                        <label for="idTecnico">Asignar a Técnico (Opcional)</label>
                        <select class="form-control" id="idTecnico" name="idTecnico">
                            <option value="">Seleccionar técnico (opcional)...</option>
                            {% for tech in technicians %}
                            <option value="{{ tech.id }}">{{ tech.name }} {{ tech.lastname }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Puede dejar este campo vacío para que el sistema asigne automáticamente un técnico</small>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Ticket</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para editar ticket -->
<div class="modal fade" id="editTicketModal" tabindex="-1" role="dialog" aria-labelledby="editTicketModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="editTicketModalLabel">
                    {% if user.role == 'ADMIN' %}Editar Ticket
                    {% else %}Cambiar Estado del Ticket{% endif %}
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editTicketForm" action="" method="POST">
                <div class="modal-body">
                    {% if user.role == 'ADMIN' %}
                    <div class="form-group">
                        <label for="edit_estado">Estado</label>
                        <select class="form-control" id="edit_estado" name="estado">
                            <option value="Abierto">Abierto</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Cerrado">Cerrado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit_prioridad">Prioridad</label>
                        <select class="form-control" id="edit_prioridad" name="prioridad">
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                            <option value="Crítica">Crítica</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit_departamento">Departamento</label>
                        <select class="form-control" id="edit_departamento" name="departamento">
                            <option value="Tecnología">Tecnología</option>
                            <option value="Contabilidad">Contabilidad</option>
                            <option value="Gerencia">Gerencia</option>
                            <option value="Recursos Humanos">Recursos Humanos</option>
                            <option value="Ventas">Ventas</option>
                            <option value="Soporte">Soporte</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit_tecnico">Asignar Técnico</label>
                        <select class="form-control" id="edit_tecnico" name="idTecnico">
                            <option value="">Seleccionar técnico...</option>
                            {% for tech in technicians %}
                            <option value="{{ tech.id }}">{{ tech.name }} {{ tech.lastname }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div class="form-group">
                        <label for="edit_estado">Estado</label>
                        <select class="form-control" id="edit_estado" name="estado">
                            <option value="Abierto">Abierto</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Cerrado">Cerrado</option>
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar la tabla con Bootstrap Table
    $('#tickets-table').bootstrapTable({
        search: true,
        showRefresh: true,
        showToggle: true,
        showColumns: true,
        pagination: true,
        pageSize: 10,
        pageList: [10, 25, 50, 100],
        showExport: true,
        exportTypes: ['csv', 'txt', 'excel'],
    });
    
    // modal de edición
    $('#editTicketModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var ticketId = button.data('ticketid');
        var estado = button.data('estado');
        var prioridad = button.data('prioridad');
        var departamento = button.data('departamento');
        var tecnico = button.data('tecnico');
        
        var modal = $(this);
        modal.find('#editTicketForm').attr('action', '/tickets/update/' + ticketId);
        modal.find('#edit_estado').val(estado);
        
        {% if user.role == 'ADMIN' %}
        modal.find('#edit_prioridad').val(prioridad);
        modal.find('#edit_departamento').val(departamento);
        if (tecnico) {
            modal.find('#edit_tecnico').val(tecnico);
        }
        {% endif %}
    });
    
    // Confirmación de eliminación con SweetAlert2
    $('.delete-form').on('submit', function(e) {
        e.preventDefault();
        var form = this;
        
        Swal.fire({
            title: '¿Está seguro?',
            text: "Esta acción no se puede deshacer",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit();
            }
        });
    });
    
    // Mostrar mensajes flash con SweetAlert2
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                Swal.fire({
                    icon: '{{ category }}',
                    title: '{{ message }}',
                    showConfirmButton: false,
                    timer: 3000,
                    toast: true,
                    position: 'top-end'
                });
            {% endfor %}
        {% endif %}
    {% endwith %}
});
</script>
{% endblock %}